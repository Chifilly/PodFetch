FROM docker-registry.schwanzer.online/dockerhub_proxy/library/node:alpine as ui-builder

WORKDIR /app
COPY ./ui/ ./
RUN  npm install && npm run build

FROM scratch as cache

COPY ./target/*x86*/release/podfetch /app/x86/podfetch
COPY ./target/*aarch64*/release/podfetch /app/arm64/podfetch
COPY ./target/*armv7*/release/podfetch /app/armv7l/podfetch


FROM docker-registry.schwanzer.online/dockerhub_proxy/bash:4.4
WORKDIR /app/
ARG TARGETPLATFORM
COPY --from=cache ./target/*$(uname -m)*/release/podfetch /app/podfetch

COPY --from=ui-builder /app/dist /app/static
COPY ./migrations /app/migrations
COPY ./db /app/db

EXPOSE 8000
CMD ["./podfetch"]